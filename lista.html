<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Turnos - Torneo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(180deg, #0f172a 0%, #071033 60%);
        color: #fff;
        min-height: 100vh;
      }
      .card {
        border-radius: 14px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      }
      .panel-title {
        font-weight: 700;
        font-size: 1.25rem;
        color: #ffd700;
      }
      .equipo {
        background: #0b1220;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .left {
        background: linear-gradient(90deg, #001f3f, #003366);
        color: #fff;
      }
      .center {
        background: linear-gradient(90deg, #0b2540, #01233d);
        color: #fff;
      }
      .right {
        background: linear-gradient(90deg, #2b0a0a, #420b0b);
        color: #fff;
      }
      .btn-sport {
        border-radius: 8px;
        font-weight: 600;
      }
      .small-muted {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.941);
      }
      table tbody tr td,
      table thead tr th {
        color: #ffffff !important;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between mb-3">
        <h2 class="panel-title">Torneo - Turnos</h2>
        <div>
          <button id="resetBtn" class="btn btn-outline-light btn-sport">
            ğŸ”„ Reiniciar Todo
          </button>
          <a href="registro.html" class="btn btn-light btn-sport ms-2"
            >Registrar</a
          >
        </div>
      </div>

      <div class="row g-3">
        <!-- IZQUIERDA: equipos -->
        <div class="col-md-4">
          <div class="card p-3 left">
            <h5 class="text-white mb-3">ğŸ“‹ Equipos Registrados</h5>
            <div id="lista-equipos" style="max-height: 65vh; overflow: auto"></div>
          </div>
        </div>

        <!-- CENTRO: orden -->
        <div class="col-md-5">
          <div class="card p-3 center">
            <h5 class="text-white mb-3">ğŸ† Orden de Juego (Cola)</h5>
            <div id="lista-orden" style="max-height: 65vh; overflow: auto"></div>
          </div>
        </div>

        <!-- DERECHA: partido actual -->
        <div class="col-md-3">
          <div class="card p-3 right">
            <h5 class="text-white mb-3">âš”ï¸ Partido Actual</h5>

            <p class="small-muted">Actual (1)</p>
            <div id="partidoA" class="equipo mb-2">-</div>

            <p class="small-muted">Retador (2)</p>
            <div id="partidoB" class="equipo mb-3">-</div>

            <div class="d-grid gap-2">
              <button id="btnGanaA" class="btn btn-success btn-sport">
                ğŸ† GanÃ³ Actual
              </button>
              <button id="btnGanaB" class="btn btn-primary btn-sport">
                ğŸ† GanÃ³ Retador
              </button>
              <button id="btnReorganizar" class="btn btn-warning btn-sport">
                ğŸ” Reorganizar Perdedor
              </button>
              <button id="btnEliminar" class="btn btn-danger btn-sport">
                âŒ Eliminar Perdedor
              </button>
              <button id="btnRetirarseA" class="btn btn-light btn-sport text-dark">
                ğŸšª Retirarse A
              </button>
              <button id="btnRetirarseB" class="btn btn-light btn-sport text-dark">
                ğŸšª Retirarse B
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal confirmar -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #071033; color: #fff; border: none">
          <div class="modal-header border-0">
            <h5 class="modal-title">Confirmar acciÃ³n</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modalBody">Â¿Confirmas?</div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="modalConfirm" type="button" class="btn btn-primary">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbxQbUse0mHnRp0JCx35KECBXuGzl1fLuhXRUmaSwXeu-qoUzwNcNez0jjlvydarDaG2/exec";

      // POST genÃ©rico
      function apiPost(params) {
        return fetch(WEB_APP_URL, {
          method: "POST",
          body: new URLSearchParams(params),
        }).then((r) => r.json());
      }

      // MODAL GENERAL
      function showConfirm(message, onConfirm) {
        const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
        document.getElementById("modalBody").innerText = message;

        document.getElementById("modalConfirm").onclick = function () {
          modal.hide();
          onConfirm();
        };

        modal.show();
      }

      // RETIRARSE (Ãºnica funciÃ³n correcta)
      async function retirar(equipo) {
        if (!equipo || equipo === "-") return;

        showConfirm(`Â¿Quieres retirar del torneo al equipo "${equipo}"?`, async () => {
          const res = await apiPost({ action: "retirar", equipo });

          if (res.status === "ok") {
            await cargar();
          } else {
            alert("Error: " + res.msg);
          }
        });
      }

      // CARGAR TODO
      async function cargar() {
        try {
          const res = await fetch(WEB_APP_URL);
          const data = await res.json();

          // ========== IZQUIERDA (SIN BOTÃ“N X) ==========
          const listaE = document.getElementById("lista-equipos");
          listaE.innerHTML =
            data.equipos
              .map(
                (e) =>
                  `<div class="equipo">
                    <div>${e.equipo}</div>
                    <div class="small-muted">${e.fecha}</div>
                  </div>`
              )
              .join("") || "<div class='small-muted'>Sin equipos</div>";

          // ========== CENTRO (CON BOTÃ“N X) ==========
          const listaO = document.getElementById("lista-orden");
          listaO.innerHTML = data.orden.length
            ? data.orden
                .map(
                  (e, i) =>
                    `<div class="equipo d-flex justify-content-between align-items-center">
                      <span>${i + 1}. ${e}</span>
                      <button class="btn btn-danger btn-sm" onclick="retirar('${e}')">âœ–</button>
                    </div>`
                )
                .join("")
            : "<div class='small-muted'>Sin cola</div>";

          // PARTIDO
          document.getElementById("partidoA").innerText = data.partidoA || "-";
          document.getElementById("partidoB").innerText = data.partidoB || "-";
        } catch (e) {
          console.error(e);
        }
      }

      // BOTONES DE PARTIDO
      document.getElementById("btnGanaA").addEventListener("click", () => {
        const A = partidoA.innerText;
        const B = partidoB.innerText;
        if (!A) return;

        showConfirm(`GanÃ³ ${A}. Se reorganizarÃ¡ al perdedor.`, async () => {
          await apiPost({
            action: "resultado",
            ganador: A,
            perdedor: B,
            loserAction: "reorganizar",
          });
          cargar();
        });
      });

      document.getElementById("btnGanaB").addEventListener("click", () => {
        const A = partidoA.innerText;
        const B = partidoB.innerText;
        if (!B) return;

        showConfirm(`GanÃ³ ${B}. Se reorganizarÃ¡ al perdedor.`, async () => {
          await apiPost({
            action: "resultado",
            ganador: B,
            perdedor: A,
            loserAction: "reorganizar",
          });
          cargar();
        });
      });

      document.getElementById("btnReorganizar").addEventListener("click", () => {
        const A = partidoA.innerText;
        const B = partidoB.innerText;
        const perdedor = B || A;

        showConfirm(`Â¿Enviar a ${perdedor} al final de la cola?`, async () => {
          await apiPost({ action: "reorganizar", equipo: perdedor });
          cargar();
        });
      });

      document.getElementById("btnEliminar").addEventListener("click", () => {
        const A = partidoA.innerText;
        const B = partidoB.innerText;
        const perdedor = B || A;

        showConfirm(
          `Â¿Eliminar permanentemente a ${perdedor}?`,
          async () => {
            await apiPost({
              action: "resultado",
              ganador: perdedor === A ? B : A,
              perdedor,
              loserAction: "eliminar",
            });
            cargar();
          }
        );
      });

      document.getElementById("btnRetirarseA").addEventListener("click", () => {
        retirar(partidoA.innerText);
      });

      document.getElementById("btnRetirarseB").addEventListener("click", () => {
        retirar(partidoB.innerText);
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        showConfirm("Â¿Reiniciar todo?", async () => {
          await apiPost({ action: "reset" });
          cargar();
        });
      });

      // carga inicial
      cargar();
      setInterval(cargar, 5000);
    </script>
  </body>
</html>
